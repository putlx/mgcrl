<!doctype html>
<html lang="zh">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="favicon.ico">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
	<script src="toast.js"></script>
	<title>mgcrl - AutoCrawl</title>
</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-light bg-light" style="z-index: 1025;">
		<div class="container-fluid">
			<a class="navbar-brand">mgcrl</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarScroll">
				<ul class="navbar-nav me-auto my-2 my-lg-0" style="--bs-scroll-height: 100px;">
					<li class="nav-item">
						<a class="nav-link" href="/">WebUI</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="/reader">Reader</a>
					</li>
					<li class="nav-item active">
						<a class="nav-link" href="/autocrawl">AutoCrawl</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="https://github.com/putlx/mgcrl">GitHub</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="input-group my-3 px-3" id="output">
		<span class="input-group-text">目录</span>
		<input type="text" class="form-control">
		<button class="btn btn-outline-secondary" type="button">保存</button>
	</div>

	<div class="input-group my-3 px-3" id="frequency">
		<span class="input-group-text">更新间隔</span>
		<input type="text" class="form-control">
		<span class="input-group-text">小时</span>
		<button class="btn btn-outline-secondary" type="button">保存</button>
	</div>

	<div class="table-responsive my-3 px-3">
		<table class="table table-sm align-middle">
			<thead>
				<tr>
					<th scope="col" class="pe-4">漫画</th>
					<th scope="col" class="pe-4">链接</th>
					<th scope="col" class="pe-4">版本</th>
					<th scope="col" class="pe-4">上次阅读</th>
					<th scope="col" class="pe-4">操作</th>
				</tr>
			</thead>
			<tbody style="white-space: nowrap;">
				<tr>
					<th scope="col" class="pe-4"><input type="text" class="form-control m-1"></th>
					<th scope="col" class="pe-4"><input type="text" class="form-control m-1"></th>
					<th scope="col" class="pe-4"><input type="text" class="form-control m-1"></th>
					<th scope="col" class="pe-4"><input type="text" class="form-control m-1"></th>
					<th scope="col" class="pe-4"><button type="button"
							class="btn btn-outline-primary btn-sm">添加</button></th>
				</tr>
			</tbody>
		</table>
	</div>

	<script>
		let config;

		function displayAsset(asset, prepend = false) {
			const tr = document.createElement("tr");
			tr.innerHTML = `
				<td class="pe-4">${asset.name}</td>
				<td class="pe-4">${asset.url}</td>
				<td class="pe-4">${asset.version}</td>
				<td class="pe-4">${asset.last_chapter}</td>
				<td class="pe-4">
					<button type="button" class="btn btn-outline-danger btn-sm">删除</button>
				</td>`;
			const tbody = document.querySelector("tbody");
			if (prepend) {
				tbody.insertBefore(tr, tbody.querySelector("tr").nextSibling);
			} else {
				tbody.appendChild(tr);
			}
			tr.querySelector("button").onclick = function () {
				fetch("/config", {
					method: "POST",
					body: JSON.stringify({
						output: config.output,
						frequency_in_hour: config.frequency_in_hour,
						remove: config.assets.indexOf(asset) + 1
					}),
					headers: new Headers({ "Content-Type": "application/json" })
				})
					.then(response => response.json())
					.then(response => {
						if (response === null) {
							tr.remove();
						} else {
							toast(`错误：${response}。`);
						}
					})
					.catch(error => {
						toast(`错误：${error.message}。`);
						console.log(error);
					});
			};
		}

		window.addEventListener("load", function () {
			fetch("/config")
				.then(response => response.json())
				.then(response => {
					if (response === null) {
						toast("未指定配置文件。");
					} else if (typeof response === "string") {
						toast(`错误：${response}。`);
					} else {
						config = response;
						document.querySelector("#output input").value = response.output;
						document.querySelector("#frequency input").value = response.frequency_in_hour;
						response.assets.forEach(displayAsset);
					}
				})
				.catch(error => {
					toast(`错误：${error.message}。`);
					console.log(error);
				});

			document.querySelector("tbody tr th button").onclick = function () {
				if (!config) return toast("未指定配置文件。");
				const group = document.querySelector("tbody tr");
				const asset = {
					name: group.querySelector("th:nth-child(1) input").value.trim(),
					url: group.querySelector("th:nth-child(2) input").value.trim(),
					version: group.querySelector("th:nth-child(3) input").value.trim(),
					last_chapter: group.querySelector("th:nth-child(4) input").value.trim()
				};
				if (!asset.url) return toast("链接不可为空");
				fetch("/config", {
					method: "POST",
					body: JSON.stringify({
						output: config.output,
						frequency_in_hour: config.frequency_in_hour,
						name: asset.name,
						url: asset.url,
						version: asset.version,
						last_chapter: asset.last_chapter
					}),
					headers: new Headers({ "Content-Type": "application/json" })
				})
					.then(response => response.json())
					.then(response => {
						if (response === null) {
							config.assets.unshift(asset);
							displayAsset(asset, true);
						} else {
							toast(`错误：${response}。`);
						}
					})
					.catch(error => {
						toast(`错误：${error.message}。`);
						console.log(error);
					});
			};

			document.querySelector("#output button").onclick = function () {
				if (!config) return toast("未指定配置文件。");
				const output = document.querySelector("#output input").value.trim();
				fetch("/config", {
					method: "POST",
					body: JSON.stringify({
						output: output,
						frequency_in_hour: config.frequency_in_hour
					}),
					headers: new Headers({ "Content-Type": "application/json" })
				})
					.then(response => response.json())
					.then(response => {
						if (response === null) {
							config.output = output;
						} else {
							document.querySelector("#output input").value = config.output;
							toast(`错误：${response}。`);
						}
					})
					.catch(error => {
						document.querySelector("#output input").value = config.output;
						toast(`错误：${error.message}。`);
						console.log(error);
					});
			};

			document.querySelector("#frequency button").onclick = function () {
				if (!config) return toast("未指定配置文件。");
				let frequency = document.querySelector("#frequency input").value.trim();
				if (frequency) {
					frequency = parseInt(frequency);
					if (isNaN(frequency)) return toast("更新间隔应为整数。");
				} else {
					frequency = 0;
				}
				fetch("/config", {
					method: "POST",
					body: JSON.stringify({
						output: config.output,
						frequency_in_hour: frequency
					}),
					headers: new Headers({ "Content-Type": "application/json" })
				})
					.then(response => response.json())
					.then(response => {
						if (response === null) {
							config.frequency = frequency;
						} else {
							document.querySelector("#frequency input").value = config.frequency;
							toast(`错误：${response}。`);
						}
					})
					.catch(error => {
						document.querySelector("#frequency input").value = config.frequency;
						toast(`错误：${error.message}。`);
						console.log(error);
					});
			};
		});
	</script>
</body>

</html>